<!-- Used by ./save-effect-samples.js (npm run effects) -->
<!DOCTYPE html>
<html>
<body>
  <script src="../dist/etro-iife.js"></script>
  <script>
    /**
     * Save a sample of a visual effect to the disk
     */
    function applyImageEffect(original, effect, path) {
      // don't overwrite original's contents
      const canvas = document.createElement('canvas')
      canvas.width = original.width
      canvas.height = original.height
      const ctx = canvas.getContext('2d')
      ctx.drawImage(original, 0, 0)
      const movie = {
        canvas: canvas, cctx: ctx,
        width: original.width, height: original.height
      }
      // for util.cache()
      effect._target = { movie }
      // Run effect
      effect.apply(movie)

      return canvas.toDataURL()
    }

    function applyAudioEffect(original, effect, path) {
      const canvas = document.createElement('canvas')
      canvas.width = canvas.height = 1
      const movie = new etro.Movie({ canvas })
      const layer = new etro.layer.Audio({ startTime: 0, source: original })
        .addEffect(effect)
      return new Promise(resolve => {
        movie
          .addLayer(layer)
          .record({ frameRate: 1, video: false }) // framerate only applies to video frames
          .then(async blob => {
            const arrayBuffer = await blob.arrayBuffer()
            const typedArray = new Uint8Array(arrayBuffer)
            const array = [...typedArray]
            const resp = await fetch(URL.createObjectURL(blob))
            resolve(array)
          })
      })
    }

    async function applyImageEffects() {
      const original = document.createElement('canvas')
      const image = await new Promise(resolve => {
        const image = new Image()
        image.src = '../spec/assets/layer/image.jpg'
        image.onload = () => {
          resolve(image)
        }
      })
      original.width = image.width
      original.height = image.height
      original.getContext('2d').drawImage(image, 0, 0)

      const effects = {
        'gaussian-blur-horizontal.png': new etro.effect.GaussianBlurHorizontal({ radius: 5 }),
        'gaussian-blur-vertical.png': new etro.effect.GaussianBlurVertical({ radius: 5 }),
        'grayscale.png': new etro.effect.Grayscale(),
        'pixelate.png': new etro.effect.Pixelate({ pixelSize: 3 }),
        'transform/translate.png': new etro.effect.Transform({
          matrix: new etro.effect.Transform.Matrix().translate(-3, 5)
        }),
        'transform/scale.png': new etro.effect.Transform({
          matrix: new etro.effect.Transform.Matrix().scale(2, 2)
        }),
        'transform/scale-fraction.png': new etro.effect.Transform({
          matrix: new etro.effect.Transform.Matrix().scale(0.5, 0.5)
        }),
        'transform/rotate.png': new etro.effect.Transform({
          matrix: new etro.effect.Transform.Matrix().rotate(Math.PI / 6)
        }),
        'transform/multiply.png': new etro.effect.Transform({
          matrix: new etro.effect.Transform.Matrix().scale(2, 2)
            .multiply(new etro.effect.Transform.Matrix().translate(-3, 5))
        })
      }

      return Object.keys(effects).map(path => {
        const effect = effects[path]
        const result = applyImageEffect(original, effect, path)
        return { path, result }
      })
    }

    async function applyAudioEffects() {
      const effects = {
        'volume.mp3': new etro.effect.Volume({ volume: 2 }),
        'panner.mp3': new etro.effect.Panner({ pan: -1 })
      }

      const items = []
      for (const path in effects) {
        const original = new Audio('../spec/assets/layer/audio.wav')
        await new Promise(resolve => {
          original.onloadeddata = resolve
        })

        const effect = effects[path]
        const result = await applyAudioEffect(original, effect, path)
        items.push({ result, path })
      }
      return items
    }

    window.onload = async () => {
      window.imageEffects = await applyImageEffects()
      window.audioEffects = await applyAudioEffects()
      window.done = true
    }
  </script>
</body>
</html>
